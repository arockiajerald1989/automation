import re
import os
import json
from typing import Optional


class TreeSearcher:
    def __init__(self, json_file_path, search_path, regex_pattern, search_for="files", max_depth: Optional[int] = None):
        """
        Initializes the TreeSearcher class.

        Args:
            json_file_path (str): Path to the JSON file.
            search_path (str): Absolute path to search within the JSON tree.
            regex_pattern (str): Regular expression pattern for searching.
            search_for (str, optional): Can be 'files', 'directories', or 'both'. Defaults to 'files'.
            max_depth (int, optional): Maximum search depth. Defaults to None (no limit).
        """
        self.json_file_path = json_file_path
        self.search_path = search_path
        self.regex_pattern = re.compile(regex_pattern)
        self.search_for = search_for
        self.max_depth = max_depth
        self.matching_files = []
        self.matching_directories = []
        self.json_data = self.load_json()

    def load_json(self):
        """Loads the JSON data from the specified file."""
        print(f"Attempting to load JSON from: {self.json_file_path}")
        if not os.path.exists(self.json_file_path):
            print(f"Error: The file {self.json_file_path} does not exist.")
            return None
        try:
            with open(self.json_file_path, 'r') as file:
                return json.load(file)
        except json.JSONDecodeError:
            print(f"Error: Could not decode JSON from {self.json_file_path}.")
            return None

    def find_node_by_absolute_path(self, node, search_path):
        """Recursively finds the node with the given absolute path."""
        if node.get('absolute_path') == search_path:
            return node

        if 'directories' in node:
            for directory in node['directories']:
                dir_name, _ = directory
                dir_node = next((d for d in node['directories'] if d[0] == dir_name), None)
                if dir_node:
                    result = self.find_node_by_absolute_path(node[dir_name], search_path)
                    if result:
                        return result
        return None

    def search_files_recursively(self, node, current_depth=0):
        """Recursively searches for files and/or directories matching the regex pattern."""
        if not node:
            return

        if self.max_depth is not None and current_depth > self.max_depth:
            return

        # Debugging: Print the current depth and node
        print(f"Current Depth: {current_depth}, Node: {node.get('absolute_path', 'No path available')}")

        # Check files in the current node
        if self.search_for in ['files', 'both'] and 'files' in node:
            for file in node['files']:
                file_name, file_size = file
                print(f"Checking file: {file_name}")
                if self.regex_pattern.match(file_name):
                    print(f"Matched file: {file_name}")
                    absolute_file_path = os.path.join(node['absolute_path'], file_name)
                    self.matching_files.append((absolute_file_path, file_size))

        # Check directories in the current node
        if self.search_for in ['directories', 'both'] and 'directories' in node:
            for directory in node['directories']:
                dir_name, dir_size = directory
                print(f"Checking directory: {dir_name}")
                if self.regex_pattern.match(dir_name):
                    print(f"Matched directory: {dir_name}")
                    absolute_dir_path = os.path.join(node['absolute_path'], dir_name)
                    self.matching_directories.append((absolute_dir_path, dir_size))

                # Recursively process subdirectories
                dir_node = node.get(dir_name, {})
                self.search_files_recursively(dir_node, current_depth + 1)

    def search_directory(self):
        """Searches the JSON tree for files or directories based on the regex pattern."""
        if not self.json_data or "devices" not in self.json_data:
            print("Error: 'devices' node not found in the JSON.")
            return

        devices_node = self.json_data["devices"]
        root = self.find_node_by_absolute_path(devices_node, self.search_path)

        if root:
            self.search_files_recursively(root, current_depth=0)
        else:
            print(f"No matching node found for {self.search_path}")

    def display_results(self):
        """Displays the matching files and directories."""
        if self.search_for in ['directories', 'both'] and self.matching_directories:
            print("\nMatching Directories:")
            for dir_path, dir_size in self.matching_directories:
                print(f"Directory: {dir_path}, Size: {dir_size}")

        if self.search_for in ['files', 'both'] and self.matching_files:
            print("\nMatching Files:")
            for file_path, file_size in self.matching_files:
                print(f"File: {file_path}, Size: {file_size}")

        if not self.matching_files and self.search_for in ['files', 'both']:
            print("\nNo matching files found.")
        if not self.matching_directories and self.search_for in ['directories', 'both']:
            print("\nNo matching directories found.")

    def save_results(self, output_file="results.json"):
        """Saves the results to a JSON file."""
        results = {
            "matching_files": self.matching_files,
            "matching_directories": self.matching_directories
        }
        with open(output_file, 'w') as file:
            json.dump(results, file, indent=4)
        print(f"Results saved to {output_file}")


# Sample Usage
tree_searcher = TreeSearcher(
    json_file_path=r"C:\Users\T14 Windows 11\PycharmProjects\path_tree\working_models\tree.json",
    search_path="C:\\Users\\T14 Windows 11\\PycharmProjects\\path_tree\\devices",
    regex_pattern=r'document.*\.pdf',  # Match both files and directories
    search_for="both",  # Search for both files and directories
    max_depth=1  # Remove depth limit for full search, or set a value (e.g., 2) to limit recursion depth
)

# Run the search
if tree_searcher.json_data:
    tree_searcher.search_directory()
    tree_searcher.display_results()
    tree_searcher.save_results()
else:
    print("Failed to load or process the JSON data.")
