import re
import os
import json
from typing import Optional

class TreeSearcher:
    def __init__(self, json_file_path, search_path, regex_pattern, search_for="files", file_size_filter=None, max_depth: Optional[int] = None):
        """
        Initialize the TreeSearcher class with necessary parameters.

        :param json_file_path: Path to the JSON file
        :param search_path: Absolute path to search within the JSON tree
        :param regex_pattern: Regular expression pattern for searching files or directories
        :param search_for: Can be 'files', 'directories', or 'both'
        :param file_size_filter: Optional size filter (e.g., '500KB') for filtering files by size
        :param max_depth: Optional integer to limit the search depth
        """
        self.json_file_path = json_file_path
        self.search_path = search_path
        self.search_for = search_for
        self.file_size_filter = file_size_filter
        self.max_depth = max_depth
        self.matching_files = []
        self.matching_directories = []

        try:
            self.regex_pattern = re.compile(regex_pattern)
        except re.error as e:
            raise ValueError(f"Invalid regex pattern: {e}")

        self.json_data = self.load_json()

    def load_json(self):
        """Load the JSON data from the specified file."""
        try:
            with open(self.json_file_path, 'r') as file:
                return json.load(file)
        except (FileNotFoundError, json.JSONDecodeError) as e:
            print(f"Error loading JSON file: {e}")
            return None

    def find_node_by_absolute_path(self, node, search_path):
        """Recursively find the node with the given absolute path."""
        if node.get('absolute_path') == search_path:
            return node

        for directory in node.get('directories', []):
            dir_name = directory[0]
            dir_node = node.get(dir_name)
            if dir_node:
                result = self.find_node_by_absolute_path(dir_node, search_path)
                if result:
                    return result
        return None

    def search_files_recursively(self, node, current_depth=0):
        """Recursively search for files and/or directories matching the regex pattern with depth control."""
        if not node or (self.max_depth is not None and current_depth > self.max_depth):
            return

        for directory in node.get('directories', []):
            dir_name, dir_size = directory
            if self.search_for in ['directories', 'both'] and self.regex_pattern.match(dir_name):
                if not self.file_size_filter or dir_size == self.file_size_filter:
                    self.matching_directories.append((os.path.join(node['absolute_path'], dir_name), dir_size))

            self.search_files_recursively(node.get(dir_name, {}), current_depth + 1)

        if self.search_for in ['files', 'both']:
            for file in node.get('files', []):
                file_name, file_size = file
                if self.regex_pattern.match(file_name):
                    if not self.file_size_filter or file_size == self.file_size_filter:
                        self.matching_files.append((os.path.join(node['absolute_path'], file_name), file_size))

    def search_directory(self):
        """Search the JSON tree for files or directories based on the regex pattern and depth control."""
        if "devices" not in self.json_data:
            print("Error: 'devices' node not found in the JSON.")
            return

        root = self.find_node_by_absolute_path(self.json_data["devices"], self.search_path)
        if root:
            self.search_files_recursively(root, current_depth=0)
        else:
            print(f"No matching node found for {self.search_path}")

    def display_results(self):
        """Display the matching files and directories."""
        if self.matching_directories:
            print("Matching Directories:")
            for dir_path, dir_size in self.matching_directories:
                print(f"Directory: {dir_path}, Size: {dir_size}")

        if self.matching_files:
            print("\nMatching Files:")
            for file_path, file_size in self.matching_files:
                print(f"File: {file_path}, Size: {file_size}")

        if not self.matching_files and self.search_for in ['files', 'both']:
            print("No matching files found.")

# Sample Usage
regex_pattern = r'document_.*\.pdf$'
search_path = "C:\\Users\\T14 Windows 11\\PycharmProjects\\path_tree\\devices"

# Create an instance of the TreeSearcher class
tree_searcher = TreeSearcher(
    json_file_path=os.path.join(os.getcwd(), 'path_tree', 'tree.json'),
    search_path=search_path,
    regex_pattern=regex_pattern,
    search_for="both",  # Search for both files and directories
    file_size_filter="500KB",  # Optional: Set to '500KB' for size-based filtering
    max_depth=3  # Limit search to a maximum depth of 3
)

# Perform the search
if tree_searcher.json_data:
    tree_searcher.search_directory()
    tree_searcher.display_results()
else:
    print("Failed to load or process the JSON data.")
